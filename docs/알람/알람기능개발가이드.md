# 실시간 알림 시스템 개발 가이드

## 📋 개요
이 문서는 Supabase 기반 실시간 알림 시스템 개발 과정과 효과적인 요청 방법을 정리한 가이드입니다.

---

## 🏗️ 시스템 구조

### 1. 핵심 구성요소
- **백엔드**: Supabase 실시간 구독 + 폴링 백업
- **상태 관리**: React 커스텀 훅 (`useConsultationNotifications`)
- **UI 컴포넌트**: 헤더 알림 + 토스트 알림
- **데이터베이스**: `consultations` 테이블 + `is_read` 컬럼

### 2. 파일 구조
```
src/
├── hooks/
│   ├── useConsultationNotifications.ts    # 알림 상태 관리
│   └── useToast.tsx                       # 토스트 알림 훅 (react-hot-toast)
├── lib/
│   ├── supabase.ts                        # Supabase 클라이언트 설정
│   └── consultationService.ts             # 상담 CRUD + 실시간 구독
├── components/
│   └── admin/
│       └── Header.tsx                     # 헤더 알림 UI
└── app/
    └── layout.tsx                         # 글로벌 Toaster 설정
```

---

## 🔧 기술적 구현

### 1. Supabase 실시간 설정
```typescript
// supabase.ts - 타임아웃 및 하트비트 설정
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  realtime: {
    params: { eventsPerSecond: 10 },
    timeout: 30000,              // 30초 타임아웃
    heartbeatIntervalMs: 30000,  // 30초 하트비트
  },
})

// 테이블 실시간 활성화 (SQL)
ALTER PUBLICATION supabase_realtime ADD TABLE consultations;
```

### 2. 이중 안전장치 시스템
```typescript
// consultationService.ts - 실시간 + 폴링 백업
subscribeToChanges(callback: (payload: any) => void) {
  // 1. 실시간 구독 시도
  const channel = supabase.channel(uniqueChannelName)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'consultations' }, callback)
    .subscribe()
  
  // 2. 실패 시 폴링으로 자동 전환
  if (status === 'TIMED_OUT' || status === 'CHANNEL_ERROR') {
    startPolling() // 5초마다 새 데이터 체크
  }
}
```

### 3. 중복 방지 로직
```typescript
// useConsultationNotifications.ts - INSERT 이벤트 처리
setLatestConsultations(prev => {
  const exists = prev.some(consultation => consultation.id === newConsultation.id);
  if (exists) {
    console.log('중복 방지:', newConsultation.id);
    return prev; // 중복이면 추가하지 않음
  }
  return [newConsultation, ...prev.slice(0, 4)];
});
```

### 4. 읽음 처리 및 제거
```typescript
// UPDATE 이벤트 처리 - 읽음 처리 시 목록에서 제거
if (updatedConsultation.is_read && !oldConsultation.is_read) {
  setUnreadCount(prev => Math.max(0, prev - 1));
  setLatestConsultations(prev => 
    prev.filter(consultation => consultation.id !== updatedConsultation.id)
  );
}
```

### 5. 토스트 알림 시스템
```typescript
// Header.tsx - 새 상담 감지 시 토스트 표시
const { showNotification, showSuccess, showError } = useToast();

useEffect(() => {
  if (hasNewConsultation) {
    showNotification('새로운 상담 접수', '새로운 고객 상담이 등록되었습니다.');
  }
}, [hasNewConsultation, showNotification]);

// Consultations 페이지 - 모든 alert() 대체
const handleStatusUpdate = async (id: string, status: string) => {
  try {
    await consultationService.updateStatus(id, status);
    showSuccess('상태가 업데이트되었습니다.');
  } catch (error) {
    showError('상태 업데이트에 실패했습니다.');
  }
};
```

---

## 🎨 UI 구성요소

### 1. 헤더 알림 벨
```typescript
// Header.tsx - 알림 카운트 표시
<Bell size={18} />
{unreadCount > 0 && (
  <span className="absolute -top-0.5 -right-0.5 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">
    {unreadCount}
  </span>
)}
```

### 2. 알림 드롭다운
- **최대 5개** 최신 읽지 않은 알림 표시
- **클릭 시 읽음 처리** 및 해당 페이지 이동
- **실시간 업데이트** (다른 탭과 동기화)

### 3. 토스트 알림 (React Hot Toast 라이브러리)
```typescript
// react-hot-toast 라이브러리 설치
npm install react-hot-toast

// useToast 훅 생성 (src/hooks/useToast.tsx)
import toast, { Toaster } from 'react-hot-toast';
import { Bell, CheckCircle, XCircle, AlertTriangle, Info } from 'lucide-react';

export const useToast = () => {
  const showSuccess = (message: string) => toast.success(message, { duration: 4000 });
  const showError = (message: string) => toast.error(message, { duration: 5000 });
  const showNotification = (title: string, message: string) => {
    toast(`${title}\n${message}`, {
      duration: 5000, // 5초 후 자동으로 사라짐
      icon: createElement(Bell, { size: 20, color: '#3b82f6' }),
      style: {
        background: '#1f2937',
        color: '#fff',
        padding: '16px 24px',
        borderRadius: '12px',
        whiteSpace: 'pre-line', // 줄바꿈 지원
      },
    });
  };
};

// app/layout.tsx에 글로벌 Toaster 추가
<Toaster position="top-right" />
```

---

## 🚀 효율적인 개발 요청 방법

### 1. 기본 알림 시스템 요청
```
"[테이블명] 테이블에 대한 실시간 알림 시스템을 만들어주세요.
- Supabase 실시간 구독 사용
- 알림 상태 관리 훅 생성  
- 실패 시 폴링 백업 시스템 포함
- 중복 방지 로직 필수"
```

### 2. 완전한 시스템 요청
```
"[테이블명] 프로덕션급 실시간 알림 시스템을 구현해주세요.

**요구사항:**
1. 백엔드: Supabase 실시간 구독 + 폴링 백업
2. 헤더 UI: 벨 아이콘 + 드롭다운 알림 목록
3. 토스트 알림: 새 알림 시 우상단 표시
4. 상호작용: 클릭 → 읽음 처리 → 목록 제거
5. 에러 처리: 타임아웃 재연결, 사용자 친화적 메시지
"
```

### 3. 특정 기능만 요청
```
"기존 알림 시스템에 [기능명] 기능을 추가해주세요."
```

---

## ⚠️ 주요 해결한 문제들

### 1. Supabase 실시간 구독 에러
**문제**: `mismatch between server and client bindings for postgres changes`
**해결**: 채널명 고유화 `consultations_${Math.random().toString(36).substr(2, 9)}`

### 2. 구독 타임아웃 에러  
**문제**: `Subscription timed out`
**해결**: 타임아웃 30초 연장 + 폴링 백업 시스템

### 3. React Key 중복 에러
**문제**: `Encountered two children with the same key`
**해결**: 중복 방지 로직 + 실시간과 폴링 데이터 구분


---

## 🎯 핵심 포인트

### 개발 시 중요사항
1. **채널명 고유화**: 매번 다른 채널명으로 충돌 방지
2. **이중 안전장치**: 실시간 실패 시 폴링으로 자동 전환  
3. **중복 방지**: ID 기반 중복 체크 로직 필수
4. **메모리 관리**: 컴포넌트 언마운트 시 구독 정리
5. **사용자 경험**: 읽음 처리 시 목록에서 제거

### 요청 시 명시사항
1. **데이터 범위**: 어떤 테이블/데이터에 대한 알림인지
2. **UI 위치**: 헤더, 사이드바, 모달 등 구체적 위치
3. **상호작용**: 클릭 시 동작, 읽음 처리 방식
4. **디자인 스타일**: 원하는 디자인 방향성
5. **기술 요구사항**: 실시간, 백업 시스템, 성능 등

---

## 📚 참고 자료

### 핵심 파일들
- `src/hooks/useConsultationNotifications.ts` - 알림 상태 관리
- `src/hooks/useToast.tsx` - 토스트 알림 훅 (react-hot-toast 기반)
- `src/lib/consultationService.ts` - 실시간 구독 + CRUD
- `src/components/admin/Header.tsx` - 헤더 알림 UI
- `app/layout.tsx` - 글로벌 Toaster 설정
- `docs/에러.md` - 개발 중 발생한 에러와 해결책

### 데이터베이스 설정
```sql
-- 실시간 활성화
ALTER PUBLICATION supabase_realtime ADD TABLE consultations;

-- 필수 컬럼
ALTER TABLE consultations ADD COLUMN IF NOT EXISTS is_read boolean DEFAULT false;
```

---

**이 가이드를 참고하면 다음번에 더 효율적으로 알림 시스템을 개발할 수 있습니다!** ✨
